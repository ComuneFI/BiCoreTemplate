dist: bionic
language: php
sudo: false

cache:
    directories:
        - $HOME/.composer/cache/files
        - $HOME/symfony-bridge/.phpunit
php:
  - 7.2
  - 7.4

services:
  - xvfb

# Configure different DB environments
env:
  matrix:
    - DB=sqlite3

addons:
  chrome: stable

before_script:
  - chmod +x bin/console
  - sudo apt-get install ant
  - phpenv config-add ./build/travis.php.ini

  #- export CHROME_BIN=chromium-browser
  #- CHROME_MAIN_VERSION=`google-chrome-stable --version | sed -E 's/(^Google Chrome |\.[0-9]+ )//g'`
  #- CHROMEDRIVER_VERSION=`curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_MAIN_VERSION"`
  #- curl "https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip" -O
  #- unzip chromedriver_linux64.zip -d ~/bin

script:
  - ant
  # - '[[ "$TRAVIS_PHP_VERSION" == "7.4" ]] || ./vendor/bin/php-cs-fixer fix --diff --dry-run -v'
  # this checks that the YAML config files contain no syntax errors
  - ./bin/console lint:yaml config --parse-tags
  # this checks that the Twig template files contain no syntax errors
  - ./bin/console lint:twig templates --env=prod
  # this checks that the XLIFF translations contain no syntax errors
  - ./bin/console lint:xliff translations
  # this checks that arguments injected into services match type declarations
  - ./bin/console lint:container
  # TODO: replace the old security checker by the new checker provided by the 'symfony' binary
  # this checks that the application doesn't use dependencies with known security vulnerabilities
  #- ./bin/console security:check
  # this checks that Doctrine's mapping configurations are valid
  - ./bin/console doctrine:schema:validate --skip-sync -vvv --no-interaction
  #  Fail CI if the repo is in a dirty state after building assets (only for current release ie install)
  #-  if [[ "$ACTION" == "install" ]]; then yarn install && yarn encore production && git add --all && git diff --staged --exit-code; fi
  - composer validate --strict

after_success:
  - rm var/cache/dbtest.sqlite

after_failure:

notifications:
  email:
  - andrea.manzi@comune.fi.it
